<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timesheet</title>
  <!--  <link rel="stylesheet" href="style.css"> -->
	<script src="/Employee/script.js"></script>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
	
	<script src="/notifications.js"></script>
	<link rel="stylesheet" href="/Employee/style.css">
    
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>



</head>
<body class="time-body">  
    
    <!-- Section 1: Header -->
    <div class="header-section d-flex justify-content-between align-items-center p-3 bg-light border-bottom">
        <h2 class="m-0">myTimesheet</h2>
		<div class="iconsmenu">
			<!-- <button>Review Another</button> -->
			<i class="bi bi-bell" id="notificationBell" onclick="toggleNotifications()"></i>
				<span id="notificationCount" class="badge badge-danger" style="display: none;">0</span>
									
									<div id="notificationDropdown" class="dropdown-menu notification-dropdown">
									        <h6 class="dropdown-header">Notifications</h6>
									        <div id="notificationList"></div>
									    </div>

						    <i class="bi bi-person-circle" id="userIcon" onclick="toggleDropdown()"></i>
							<span id="userName" style="color: black; margin-left: 10px; display: none;"></span>
							

						    <div id="userDropdown" class="dropdown-menu">
						        <a href="#" class="dropdown-item">Change Password</a>
						        <a href="#" class="dropdown-item">Switch Admin</a>
								<a href="#" class="dropdown-item" id="logout">Logout</a>
						    </div>
						</div>
						
					
    </div>

	<!-- Change Password Modal -->
	<div class="modal" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
	    <div class="modal-dialog">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="changePasswordModalLabel">Change Your Password</h5>
	                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	            </div>
	            <div class="modal-body">
	                <form>
	                    <div class="mb-3">
	                        <label for="newPassword" class="form-label">New Password</label>
	                        <input type="password" class="form-control" id="newPassword" placeholder="Enter your new password" required>
	                        <div id="passwordError" style="color: red; display: none;"></div>
	                    </div>
	                    <div class="mb-3">
	                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
	                        <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm your new password" required>
	                    </div>
	                </form>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
	                <button type="button" class="btn btn-primary" id="sendOtpBtn">Send OTP</button>
	            </div>
	        </div>
	    </div>
	</div>



	<!-- OTP Modal -->
	<div class="modal" id="otpModal" tabindex="-1" aria-labelledby="otpModalLabel" aria-hidden="true">
	    <div class="modal-dialog">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="otpModalLabel">Enter OTP</h5>
	                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	            </div>
	            <div class="modal-body">
	                <form>
	                    <div class="mb-3">
	                        <label for="otp" class="form-label">One-Time Password (OTP)</label>
	                        <input type="text" class="form-control" id="otp" placeholder="Enter the OTP sent to your email" required>
	                        <div id="otpError" style="color: red; display: none;"></div>
	                    </div>
	                </form>
	                <!-- Timer Display -->
	                <div id="timerDisplay" style="margin-top: 10px;"></div>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
	                <button type="button" class="btn btn-primary" id="changePasswordBtn">Change Password</button>
	                <button type="button" class="btn btn-warning" id="resendOtpBtn" style="display: none;">Resend OTP</button>
	            </div>
	        </div>
	    </div>
	</div>

	
    <!-- Section 2: Navigation -->
    <div class="navigation-section d-flex p-2 bg-white border-bottom align-items-center">
        <ul class="nav flex-grow-1">
            <li class="nav-item"><a class="nav-link" data-target="timeSection" href="#">Time</a></li>
            <li class="nav-item"><a class="nav-link" data-target="expenseSection" href="#">Expense</a></li>
            <li class="nav-item"><a class="nav-link" data-target="locationSection" href="#">Location</a></li>
            <li class="nav-item"><a class="nav-link" data-target="chargecodesSection" href="#">Charge Codes</a></li>
            <li class="nav-item"><a class="nav-link" data-target="summarySection" href="#">Summary</a></li>
            <li class="nav-item"><a class="nav-link" data-target="preferenceSection" href="#">Preference</a></li>
        </ul>
    
        <!-- Date Controls -->
         <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm" id="prevPeriod"><</button>
            <select class="form-select form-select-sm w-auto" id="periodDropdown"></select>
            <button class="btn btn-sm" id="nextPeriod">></button>
            <input type="date" class="form-control form-control-sm w-auto" id="calendarPicker">
            
            <!-- Printer Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="25" fill="currentColor" class="bi bi-printer-fill" viewBox="0 0 16 16">
                <path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1"/>
                <path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2zm2.5 1a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"/>
            </svg>
        </div>
    </div>

    <!-- Section 3: Controls -->
    <div class="controls-section d-flex justify-content-between align-items-center p-3 bg-light border-bottom">
        <div class="d-flex gap-3">
            <!-- Save Icon -->
			<svg id="saveIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-floppy-fill" viewBox="0 0 16 16">
			                <path d="M0 1.5A1.5 1.5 0 0 1 1.5 0H3v5.5A1.5 1.5 0 0 0 4.5 7h7A1.5 1.5 0 0 0 13 5.5V0h.086a1.5 1.5 0 0 1 1.06.44l1.415 1.414A1.5 1.5 0 0 1 16 2.914V14.5a1.5 1.5 0 0 1-1.5 1.5H14v-5.5A1.5 1.5 0 0 0 12.5 9h-9A1.5 1.5 0 0 0 2 10.5V16h-.5A1.5 1.5 0 0 1 0 14.5z"/>
			                <path d="M3 16h10v-5.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5zm9-16H4v5.5a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5zM9 1h2v4H9z"/>
			            </svg>
    
            <!-- Delete Icon -->
            <svg id="deleteIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
            </svg>
			
			<!-- Set Template -->
			<i class="bi bi-copy" id="templateIcon"></i> 
			
            <!-- Add Row Icon -->
            <svg  xmlns="http://www.w3.org/2000/svg" id="addRow" width="26" height="26" fill="currentColor" class="bi bi-plus-circle-dotted" viewBox="0 0 16 16">
                <path d="M8 0q-.264 0-.523.017l.064.998a7 7 0 0 1 .918 0l.064-.998A8 8 0 0 0 8 0M6.44.152q-.52.104-1.012.27l.321.948q.43-.147.884-.237L6.44.153zm4.132.271a8 8 0 0 0-1.011-.27l-.194.98q.453.09.884.237zm1.873.925a8 8 0 0 0-.906-.524l-.443.896q.413.205.793.459zM4.46.824q-.471.233-.905.524l.556.83a7 7 0 0 1 .793-.458zM2.725 1.985q-.394.346-.74.74l.752.66q.303-.345.648-.648zm11.29.74a8 8 0 0 0-.74-.74l-.66.752q.346.303.648.648zm1.161 1.735a8 8 0 0 0-.524-.905l-.83.556q.254.38.458.793l.896-.443zM1.348 3.555q-.292.433-.524.906l.896.443q.205-.413.459-.793zM.423 5.428a8 8 0 0 0-.27 1.011l.98.194q.09-.453.237-.884zM15.848 6.44a8 8 0 0 0-.27-1.012l-.948.321q.147.43.237.884zM.017 7.477a8 8 0 0 0 0 1.046l.998-.064a7 7 0 0 1 0-.918zM16 8a8 8 0 0 0-.017-.523l-.998.064a7 7 0 0 1 0 .918l.998.064A8 8 0 0 0 16 8M.152 9.56q.104.52.27 1.012l.948-.321a7 7 0 0 1-.237-.884l-.98.194zm15.425 1.012q.168-.493.27-1.011l-.98-.194q-.09.453-.237.884zM.824 11.54a8 8 0 0 0 .524.905l.83-.556a7 7 0 0 1-.458-.793zm13.828.905q.292-.434.524-.906l-.896-.443q-.205.413-.459.793zm-12.667.83q.346.394.74.74l.66-.752a7 7 0 0 1-.648-.648zm11.29.74q.394-.346.74-.74l-.752-.66q-.302.346-.648.648zm-1.735 1.161q.471-.233.905-.524l-.556-.83a7 7 0 0 1-.793.458zm-7.985-.524q.434.292.906.524l.443-.896a7 7 0 0 1-.793-.459zm1.873.925q.493.168 1.011.27l.194-.98a7 7 0 0 1-.884-.237zm4.132.271a8 8 0 0 0 1.012-.27l-.321-.948a7 7 0 0 1-.884.237l.194.98zm-2.083.135a8 8 0 0 0 1.046 0l-.064-.998a7 7 0 0 1-.918 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3z"/>
            </svg>
			
		
        </div> 

    
        <div class="col-6 d-flex justify-content-end gap-3 ">
              
            <button class="btn btn-success" id="sendApprovalBtn">Send Approval</button>
            <button id="submitBtn" class="btn btn-info">Submit</button>
        </div>
    </div>

    <p id="selectedPeriod">Selected Period:</p>
    <div id="timeSection" class="content-section">
        <table class="table table-bordered" style="padding: 0px !important;">
            <thead id="tableHeaders" style="padding: 0px !important;">
                <tr style="padding: 0px;"></tr>
            </thead>
            <tbody id="tableBody" style="padding: 0px !important;"></tbody>
            <tfoot id="tableFooter" style="padding: 0px !important;">
                <tr></tr>
            </tfoot> 
        </table>
    </div>


<!-- Section for Expense -->
<div id="expenseSection" class="content-section" style="display: none;">
    <h3>Expense Section</h3>
    <p>This is where expense details will go.</p>
</div>  

<!-- Section for Location -->
<div id="locationSection" class="content-section" style="display: none;">
    <h3>Location Section</h3>
    <p>This is where location details will go.</p>
</div>


	
<!-- Section for Charge Codes in Employee Page -->
<div id="chargecodesSection" class="content-section container-fluid mt-4" style="display: none; padding: 20px;">
    
    <!-- Header Section with Sorting Dropdown -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="text-primary">Charge Code List</h3>
        <select id="projectTypeFilter" class="form-select w-auto">
            <option value="All">All</option>
            <option value="External">External</option>
            <option value="Internal">Internal</option>
        </select>
    </div>
    
    <div class="table-responsive">
        <table class="table table-hover table-bordered w-100">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Code Type</th>
                    <th>Code</th>
                    <th>Client Name</th>
                    <th>Description</th>
                    <th>Project Type</th>
                    <th>Start Date</th>
                    <th>Country</th>
                </tr>
            </thead>
            <tbody id="employee-code-table-body" class="table-group-divider"></tbody>
        </table>
    </div>
</div>


<!-- Section for Summary -->
<div id="summarySection" class="content-section" style="display: none;">
	<div id="summarySection">
	    <h2 style="text-align: center;">General Summary</h2>
	    <table class="summary-table" border="1" align="center">
	        <thead>
	            <tr>
	                <th>Charge Code</th>
	                <th>Working Hours</th>
	                <th>Total Expense</th>
	                <th>Absences Hours</th>
	            </tr>
	        </thead>
	        <tbody id="summaryBody">
	            <!-- Data will be inserted here dynamically -->
	        </tbody>
	        <tfoot>
	            <tr>
	                <td>Total Hours</td>
	                <td id="totalHours">0</td>
	                <td id="totalExpense">0</td>
	                <td id="totalAbsences">0</td>
	            </tr>
				
	            <tr>
	                <td>Standard Allocated Hours</td>
	                <td id="standardHours">135</td>
	                <td>-</td>
	                <td>-</td>
	            </tr>
				
				<tr>
				    <td>Total Working Hours</td>
					<td id="totalworking">0</td>
					<td>-</td>
					<td>-</td>
				</tr>
	        </tfoot>
	    </table>

	    <h3 style="text-align: center;">Location Summary</h3>
	    <table class="summary-table" border="1" align="center">
	        <thead>
	            <tr>
	                <th>Country</th>
	                <th>Location</th>
	                <th>Total Hours</th>
	            </tr>
	        </thead>
	        <tbody>
	            <tr> 
	                <td>India</td>
	                <td>Salem - 00 | Company code - 001  - Salem</td>
	                <td id="locationTotalHours">0</td>
	            </tr>
	        </tbody>
	    </table>
	</div><br><br>
	
	</div>

	<!-- Section for Preference -->
	<div id="preferenceSection" class="content-section" style="display: none;">
	    <h3 class="text-center mb-4">Preference Section</h3>
	    <p class="text-center text-muted">Adjust your preferences here.</p>

	    <div class="container preference-container">
	        <!-- Approvers -->
	        <div class="row preference-row">
	            <div class="col-md-5">
	                <label class="form-label">Approvers</label>
	                <div class="dropdown">
	                    <button class="btn btn-light dropdown-toggle form-control" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="approversDropdown">
	                        Select Approver
	                    </button>
	                    <ul class="dropdown-menu" id="approversList"></ul>
	                </div>
	            </div>
	            <div class="col-md-2 d-flex flex-column align-items-center justify-content-center">
	               <!--  <button class="btn btn-primary btn-sm mb-2" onclick="addApprover()">➝</button> -->
	                <button class="btn btn-danger btn-sm" onclick="removeLastEntry('selectedApprovers')">←</button>
	            </div>
	            <div class="col-md-5">
	                <label class="form-label">Selected Approvers</label>
	                <textarea class="form-control selected-box" id="selectedApprovers" readonly></textarea>
	            </div>
	        </div>

	        <!-- Reviewers -->
	        <div class="row preference-row">
	            <div class="col-md-5">
	                <label class="form-label">Reviewer</label>
	                <div class="dropdown">
	                    <button class="btn btn-light dropdown-toggle form-control" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="reviewersDropdown">
	                        Select Reviewer
	                    </button>
	                    <ul class="dropdown-menu" id="reviewersList"></ul>
	                </div>
	            </div>
	            <div class="col-md-2 d-flex flex-column align-items-center justify-content-center">
	                <!-- <button class="btn btn-primary btn-sm mb-2" onclick="addReviewer()">➝</button> -->
	                <button class="btn btn-danger btn-sm" onclick="removeLastEntry('selectedReviewers')">←</button>
	            </div>
	            <div class="col-md-5">
	                <label class="form-label">Selected Reviewers</label>
	                <textarea class="form-control selected-box" id="selectedReviewers" readonly></textarea>
	            </div>
	        </div>

	        <!-- Delegators -->
	        <div class="row preference-row">
	            <div class="col-md-5">
	                <label class="form-label">Delegators</label>
	                <div class="dropdown">
	                    <button class="btn btn-light dropdown-toggle form-control" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="delegatorsDropdown">
	                        Select Delegator
	                    </button>
	                    <ul class="dropdown-menu" id="delegatorsList"></ul>
	                </div>
	            </div>
	            <div class="col-md-2 d-flex flex-column align-items-center justify-content-center">
	                <!-- <button class="btn btn-primary btn-sm mb-2" onclick="addDelegator()">➝</button> -->
	                <button class="btn btn-danger btn-sm" onclick="removeLastEntry('selectedDelegators')">←</button>
	            </div>
	            <div class="col-md-5">
	                <label class="form-label">Selected Delegators</label>
	                <textarea class="form-control selected-box" id="selectedDelegators" readonly></textarea>
	            </div>
	        </div>

	        <!-- Buttons Section -->
	        <div class="text-center mt-4">
	            <button class="btn btn-secondary me-2" onclick="resetPreferences()">Reset</button>
	            <button class="btn btn-success" onclick="savePreferences()">Save</button>
	        </div>
	    </div>
	</div>


	
	<div id="customAlert" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;">
	    <div id="alertToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
	        <div class="d-flex">
	            <div class="toast-body" id="alertMessage">
	                <!-- Alert Message Will Appear Here -->
	            </div>
	            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
	        </div>
	    </div>
	</div>

<script>
	
	// Add this in script.js
	function showAlert(message, type = 'success') {
	    const alertToast = document.getElementById('alertToast');
	    const alertMessage = document.getElementById('alertMessage');
	    
	    // Set message and type (success/error)
	    alertMessage.textContent = message;
	    alertToast.className = `toast align-items-center text-white bg-${type} border-0`;
	    
	    // Show the toast
	    const toast = new bootstrap.Toast(alertToast);
	    toast.show();
	}
	
	
	document.addEventListener("DOMContentLoaded", function () {
		const submitbtn = document.getElementById('submitBtn');
		const addname = localStorage.getItem('userAddRole');
		if (addname === "-") {
			submitbtn.disabled = true;
			submitbtn.style.display="none";
		}  
		else{
			submitbtn.disabled = false;
		}
		});

		   
		   
	document.addEventListener("DOMContentLoaded", function () {

	    const saveIcon = document.querySelector(".bi-floppy-fill");
	    const deleteIcon = document.querySelector(".bi-trash");
	    const addRowIcon = document.getElementById("addRow");
		const templateIcon = document.getElementById("templateIcon");

	    function updateIcons() {
	        const activeSection = document.querySelector(".content-section:not([style*='display: none'])");

	        if (!activeSection) return; // No active section, do nothing

	        // **Show/Hide Icons Instead of Removing Them**
	        if (activeSection.id === "timeSection") {
	            saveIcon.style.display = "inline-block";
	            deleteIcon.style.display = "inline-block";
	            addRowIcon.style.display = "inline-block"; // Keep addRow functional
				templateIcon.style.display = "inline-block"
	        } else if (activeSection.id === "locationSection" || activeSection.id === "preferenceSection") {
	            saveIcon.style.display = "inline-block";
	            deleteIcon.style.display = "inline-block";
	            addRowIcon.style.display = "none"; // Hide addRow but keep it in DOM
				templateIcon.style.display = "none"
	        } else {
	            saveIcon.style.display = "none";
	            deleteIcon.style.display = "none";
	            addRowIcon.style.display = "none";
				templateIcon.style.display = "none"
	        }
	    }

	    // Attach event listener to navigation links
	    document.querySelectorAll(".nav-link").forEach(link => {
	        link.addEventListener("click", function () {
	            setTimeout(updateIcons, 100); // Delay for smooth transition
	        });
	    });

	    // Run initially
	    updateIcons();
	});




	          document.addEventListener("DOMContentLoaded", function() {
		
	          const userName = localStorage.getItem('userName');
	          console.log(userName); // Debugging: Check if the value is correct

	          if (userName) {
	              const userNameElement = document.getElementById('userName');
	              userNameElement.innerText = userName;
	              userNameElement.style.display = 'inline'; // Show the name under the icon
	          }
	      });

		  // Function to toggle the dropdown menu visibility
		  function toggleDropdown() { 
		      const dropdown = document.getElementById('userDropdown');
		      dropdown.style.display = (dropdown.style.display === 'block') ? 'none' : 'block';
		  }


		  document.addEventListener('click', function(event) {
		      const dropdown = document.getElementById('userDropdown');
		      const userIcon = document.getElementById('userIcon');
		      if (!userIcon.contains(event.target) && !dropdown.contains(event.target)) {
		          dropdown.style.display = 'none';
		      }
		  });
		  

		  /*change password with otp*/
		  		
		  		let otp; // This will store the OTP sent to the email
		  		let otpTimer; // To store the timer for OTP expiration
		  		let countdown = 120; // 2 minutes countdown in seconds

		  		// Function to update the timer display
		  		function updateTimerDisplay() {
		  		    const timerDisplay = document.getElementById('timerDisplay');
		  		    if (timerDisplay) {
		  		        const minutes = Math.floor(countdown / 60);
		  		        const seconds = countdown % 60;
		  		        timerDisplay.innerText = `Time remaining: ${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
		  		    }
		  		}

		  		// Event listener for opening the change password modal
		  		document.getElementById('userDropdown').addEventListener('click', function (e) {
		  		    if (e.target.innerText === 'Change Password') {
		  		        // Open the modal when 'Change Password' is clicked
		  		        var changePasswordModal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
		  		        changePasswordModal.show();
		  		    }
		  		});

		  		// Send OTP when the "Send OTP" button is clicked
		  		document.getElementById('sendOtpBtn').addEventListener('click', function () {
		  		    const newPassword = document.getElementById('newPassword').value;
		  		    const confirmPassword = document.getElementById('confirmPassword').value;
		  		    const passwordError = document.getElementById('passwordError');
		  		    
		  		    // Hide previous error message
		  		    passwordError.style.display = 'none';

		  		    // Validate password fields
		  		    if (!newPassword || !confirmPassword) {
		  		        passwordError.style.display = 'block';
		  		        passwordError.innerHTML = "Both fields are required.";
		  		        return;
		  		    }

		  		    if (newPassword !== confirmPassword) {
		  		        passwordError.style.display = 'block';
		  		        passwordError.innerHTML = "Passwords do not match.";
		  		        return;
		  		    }

		  		    // Send the request to the backend to send OTP to the user's email
		  		    const email = localStorage.getItem('userName');  // Get the email of the logged-in user

		  		    fetch("/send-otp", {
		  		        method: "POST",
		  		        headers: {
		  		            "Content-Type": "application/json"
		  		        },
		  		        body: JSON.stringify({ email: email })
		  		    })
		  		    .then(response => response.json())
		  		    .then(result => {
		  		        if (result.success) {
		  		            otp = result.otp;  // Store the OTP
		  		            var otpModal = new bootstrap.Modal(document.getElementById('otpModal'));
		  		            otpModal.show();

		  		            // Start the countdown timer
		  		            countdown = 120; // Reset countdown to 2 minutes
		  		            updateTimerDisplay();
		  		            otpTimer = setInterval(function() {
		  		                countdown--;
		  		                updateTimerDisplay();
		  		                if (countdown <= 0) {
		  		                    clearInterval(otpTimer);
		  		                    document.getElementById('sendOtpBtn').style.display = 'none'; // Hide Send OTP button
		  		                    document.getElementById('resendOtpBtn').style.display = 'inline-block'; // Show Resend OTP button
		  		                }
		  		            }, 1000);

		  		        } else {
		  		            showAlert("Failed to send OTP. Please try again.", "danger");
		  		        }
		  		    })
		  		    .catch(error => {
		  		        console.error("Error:", error);
		  		        showAlert("An error occurred. Please try again later.", "danger");
		  		    });
		  		});

		  		// Resend OTP functionality
		  		document.getElementById('resendOtpBtn').addEventListener('click', function() {
		  		    // Trigger the same functionality as the "Send OTP" button
		  		    document.getElementById('sendOtpBtn').click();
		  		    // Hide the Resend OTP button after clicking
		  		    document.getElementById('resendOtpBtn').style.display = 'none';
		  		});

		  		// Change password after OTP validation
		  		document.getElementById('changePasswordBtn').addEventListener('click', function () {
		  		    const enteredOtp = document.getElementById('otp').value;
		  		    const otpError = document.getElementById('otpError');

		  		    otpError.style.display = 'none';

		  		    // Validate OTP
		  		    if (!enteredOtp) {
		  		        otpError.style.display = 'block';
		  		        otpError.innerHTML = "OTP is required.";
		  		        return;
		  		    }

		  		    // Send the OTP and password to the backend for validation
		  		    const newPassword = document.getElementById('newPassword').value;

		  		    fetch("/change-password", {
		  		        method: "POST",
		  		        headers: {
		  		            "Content-Type": "application/json"
		  		        },
		  		        body: JSON.stringify({
		  		            email: localStorage.getItem('userName'),
		  		            newPassword: newPassword,
		  		            otp: enteredOtp
		  		        })
		  		    })
		  		    .then(response => response.json())
		  		    .then(result => {
		  		        if (result.success) {
		  		            showAlert("Your password was changed successfully.", "success");

		  		            // Close the OTP modal (password change form)
		  		            var otpModal = bootstrap.Modal.getInstance(document.getElementById('otpModal'));
		  		            otpModal.hide();  // Hide the OTP modal after successful password change
		  					
		  					// Close the Change Password modal (in case it is still open)
		  					          var changePasswordModal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
		  					          changePasswordModal.hide();  // Hide the Change Password modal as well

		  		            // Reset the OTP field and form for clean state
		  		            document.getElementById('otp').value = '';
		  		            document.getElementById('newPassword').value = '';
		  		            document.getElementById('confirmPassword').value = '';

		  		            // Optional: Hide the Resend OTP button again, in case the modal is reopened
		  		            document.getElementById('resendOtpBtn').style.display = 'none';
		  		            document.getElementById('sendOtpBtn').style.display = 'inline-block';
		  		        } else {
		  		            console.log("Error response:", result); // Debug log to check the response from backend
		  		            showAlert("Failed to change the password. Please try again.", "danger");
		  		        }
		  		    })
		  		    .catch(error => {
		  		        console.error("Error:", error);
		  		        showAlert("An error occurred. Please try again later.", "danger");
		  		    });
		  		});

				
				/*script for logout*/
				document.getElementById('logout').addEventListener('click', function(event) {
				       event.preventDefault();

				       // Clear any session or localStorage data if needed
				       localStorage.removeItem('userName'); // Example of clearing the user name stored in localStorage

				       // Redirect to the login page
				       window.location.href = '/login'; // Redirect to the login page or wherever needed
					   alert("Logout Successfully..! ");
				   });
				
				
				
				   /*script for swtching role*/
				   
				   document.querySelector('.dropdown-menu').addEventListener('click', function(event) {
				       event.preventDefault();

				       // Check if the clicked item is 'Switch Admin'
				       if (event.target.innerText === 'Switch Admin') {
				           const userEmail = localStorage.getItem('userEmail');  // Fetch the email from localStorage

				           if (!userEmail) {
				               showAlert("User is not logged in. Please log in first.", "danger");
				               return;
				           }

				           // Send the email to backend to check if the user can switch to Admin
				           fetch('/check-admin-role', {
				               method: 'POST',
				               headers: {
				                   'Content-Type': 'application/json'
				               },
				               body: JSON.stringify({ email: userEmail })
				           })
				           .then(response => response.json())
				           .then(data => {
				               if (data.success) {
				                   // The user is authorized to switch to Admin panel
				                   localStorage.setItem('userName', data.eName);  // Store the new name (from Admin)
				                   localStorage.setItem('userRole', "Admin");  // Update role to Admin
				                   
								   
				                   // Redirect to Admin Dashboard
				                   window.location.href = "/Admin_Dashboard";
				               } else {
				                   showAlert("You do not have permission to switch to the Admin panel.", "danger");
				               }
				           })
				           .catch(error => {
				               console.error("Error:", error);
				               showAlert("An error occurred. Please try again.", "danger");
				           });
				       }
				   });

				       
						
				
					   
		  /*script for calender*/
		  
		  const today = new Date();
		          let currentYear = today.getFullYear();
		          let currentMonth = today.getMonth() + 1;
		          let currentPeriodIndex = 0; 
		  

		          function formatDate(date) {
		              const year = date.getFullYear();
		              const month = (`0${date.getMonth() + 1}`).slice(-2); // Add leading zero
		              const day = (`0${date.getDate()}`).slice(-2); // Add leading zero
		              return `${year}-${month}-${day}`;
		          }

		          function setCalendarLimits() {
		              const threeMonthsBefore = new Date(today);
		              threeMonthsBefore.setMonth(today.getMonth() - 3);
		              
		              const threeMonthsAfter = new Date(today);
		              threeMonthsAfter.setMonth(today.getMonth() + 3);
		              
		              const calendarPicker = document.getElementById('calendarPicker');
		              calendarPicker.min = formatDate(threeMonthsBefore);
		              calendarPicker.max = formatDate(threeMonthsAfter);
		          }

		          function getPeriods() {
		              const periods = [];
		              const baseDate = new Date(today);
		              
		              // Loop to create periods for 3 months before and 3 months after the current date
		              for (let i = -3; i <= 3; i++) {
		                  const monthOffset = new Date(baseDate.getFullYear(), baseDate.getMonth() + i, 1);
		                  const firstHalf = {
		                      start: `01/${(`0${monthOffset.getMonth() + 1}`).slice(-2)}/${monthOffset.getFullYear()}`,
		                      end: `15/${(`0${monthOffset.getMonth() + 1}`).slice(-2)}/${monthOffset.getFullYear()}`
		                  };
		                  const lastDayOfMonth = new Date(monthOffset.getFullYear(), monthOffset.getMonth() + 1, 0).getDate();
		                  const secondHalf = {
		                      start: `16/${(`0${monthOffset.getMonth() + 1}`).slice(-2)}/${monthOffset.getFullYear()}`,
		                      end: `${lastDayOfMonth}/${(`0${monthOffset.getMonth() + 1}`).slice(-2)}/${monthOffset.getFullYear()}`
		                  };
		                  
		                  periods.push(firstHalf, secondHalf);
		              }

		              const todayDate = `${today.getDate()}/${today.getMonth() + 1 < 10 ? '0' + (today.getMonth() + 1) : today.getMonth() + 1}/${today.getFullYear()}`;
		              periods.forEach((period, index) => {
		                  if (isDateInRange(todayDate, period.start, period.end)) {
		                      currentPeriodIndex = index;
		                  }
		              });
		              
		              return periods;
		          }

		          function isDateInRange(date, startDate, endDate) {
		              const [dDay, dMonth, dYear] = date.split('/');
		              const [sDay, sMonth, sYear] = startDate.split('/');
		              const [eDay, eMonth, eYear] = endDate.split('/');
		              const dateObj = new Date(dYear, dMonth - 1, dDay);
		              const startObj = new Date(sYear, sMonth - 1, sDay);
		              const endObj = new Date(eYear, eMonth - 1, eDay);
		              return dateObj >= startObj && dateObj <= endObj;
		          }
		          const periods = getPeriods();

		          function updateDropdown() {
		              const periodDropdown = document.getElementById('periodDropdown');
		              periodDropdown.innerHTML = '';
		              periods.forEach((period, index) => {
		                  const option = document.createElement('option');
		                  option.value = index;
		                  option.textContent = `${period.start} - ${period.end}`;
		                  if (index === currentPeriodIndex) {
		                      option.selected = true;
		                  }
		                  periodDropdown.appendChild(option);
		              });
		          }


		 let chargeCodes = [];

				  // Fetch charge codes from backend
		     function fetchChargeCodes() {
				  	fetch("/getChargecodes")
				  		.then(response => response.json())
				  		.then(data => {
				  			  chargeCodes = data;
				  			       populateDropdowns(); // Populate static + new rows
				  			  })
				  		.catch(error => console.error("Error fetching Charge codes:", error));
				   }

				   function createDropdown(isDynamicRow = false) {
				       const container = document.createElement("div");
				       container.classList.add("dropdown-container");
				       container.style.display = "flex";
				       container.style.alignItems = "center";
				       container.style.justifyContent = "space-between";
				       container.style.width = "100%";

				       // Dropdown button (Displays selected charge code)
				       const button = document.createElement("div");
				       button.classList.add("dropdown-button");
				       button.textContent = "Select Charge Code";
				       button.style.display = "flex";
				       button.style.alignItems = "center";
				       button.style.flexGrow = "1";

				       // Remove (✖) button
				       const clearButton = document.createElement("span");
				       clearButton.textContent = "✖";
				       clearButton.style.cursor = "pointer";
				       clearButton.style.marginLeft = "8px";
				       clearButton.style.color = "red";
				       clearButton.style.fontSize = "10px";
				       clearButton.style.fontWeight = "bold";
				       clearButton.style.display = "none";
				       clearButton.title = "Remove selected charge code";

				       // Right Arrow Icon (➤) - Calls fillRowWithFirstValue()
				       const arrowIcon = document.createElement("span");
				       arrowIcon.textContent = "➤";
				       arrowIcon.style.cursor = "pointer";
				       arrowIcon.style.marginLeft = "auto"; 
				       arrowIcon.style.fontSize = "14px";  
				       arrowIcon.style.fontWeight = "bold";
				       arrowIcon.style.color = "#000";  
				       arrowIcon.style.display = isDynamicRow ? "inline" : "none"; 
				       arrowIcon.title = "Replication";
				       
				       // ✅ Ensure it calls the function on click
				       arrowIcon.addEventListener("click", function(event) {
				           event.stopPropagation(); // Prevent dropdown from closing
				           fillRowWithFirstValue(this);
				       });

				       // Dropdown panel
				       const panel = document.createElement("div");
				       panel.classList.add("dropdown-panel");

				       // Search input inside dropdown
				       const searchInput = document.createElement("input");
				       searchInput.type = "text";
				       searchInput.placeholder = "Search...";
				       searchInput.classList.add("dropdown-search");
				       panel.appendChild(searchInput);

				       // Populate dropdown options from chargeCodes array
				       chargeCodes.forEach(code => {
				           const option = document.createElement("div");
				           option.classList.add("dropdown-option");
				           option.textContent = `${code.code} - ${code.description}`;
				           option.dataset.value = code.code;

				           option.addEventListener("click", function () {
				               button.textContent = option.textContent;  
				               button.appendChild(clearButton);  
				               panel.style.display = "none";
				               clearButton.style.display = "inline";  
				               arrowIcon.style.display = "inline";  // Ensure arrow remains after selection
				           });

				           panel.appendChild(option);
						   
				       });
					   

				       // Handle remove functionality
				       clearButton.addEventListener("click", function (event) {
				           event.stopPropagation();  
				           button.textContent = "Select Charge Code";  
				           clearButton.style.display = "none";  
				           arrowIcon.style.display = isDynamicRow ? "inline" : "none"; // Keep arrow for dynamic rows
				       });

				       // Handle search functionality  
				       searchInput.addEventListener("input", function () {
				           const filter = searchInput.value.toLowerCase();
				           const options = panel.querySelectorAll(".dropdown-option");
				           options.forEach(option => {
				               option.style.display = option.textContent.toLowerCase().includes(filter) ? "block" : "none";
				           });
				       });

				       // Toggle dropdown visibility
				       button.addEventListener("click", function () {
				           panel.style.display = panel.style.display === "block" ? "none" : "block";
						   addRow();
				       });

				       // Close dropdown when clicking outside
				       document.addEventListener("click", function (event) {
				           if (!container.contains(event.target)) {
				               panel.style.display = "none";
				           }
				       });
					   
				
				       container.appendChild(button);
				       container.appendChild(clearButton);
				       container.appendChild(arrowIcon); 
				       container.appendChild(panel);
				       
				       return container;
					   
					  
				   }

				   function fillRowWithFirstValue(button) {
				       const row = button.closest("tr"); 
				       const inputs = row.querySelectorAll("td input[type='text']"); 
				       let firstValue = null;

				       console.log("Before filling:", Array.from(inputs).map(input => input.value));

				       // Find the first non-empty, non-disabled value (ONLY from columns 1-16)
				       inputs.forEach((input, index) => {
				           if (index >= 1 && index <= 16 && !input.disabled && firstValue === null && input.value.trim() !== "") {
				               firstValue = input.value;
				           }
				       });

				       // If a valid value is found, fill the row (ONLY in columns 1-16)
				       if (firstValue !== null) {
				           inputs.forEach((input, index) => {
				               if (index >= 1 && index <= 16 && !input.disabled) { // ✅ Includes 16th column for longer months
				                   input.value = firstValue;  
				                   input.dispatchEvent(new Event('input')); // Ensure change is registered
				               }
				           });

				           console.log("After filling:", Array.from(inputs).map(input => input.value));

				           // ✅ Ensure the total is updated correctly
				           setTimeout(() => {
				               calculateTotals();
				           }, 10);
				       }
				   }






		// Add static rows (Work Location & Company Code)
			function addStaticRows() {
				
					const tableBody = document.getElementById("tableBody");
					const staticRowData = [
							 { name: "Work Location", value: "00" },
							 { name: "Company Code", value: "001" }
						];
						
					staticRowData.forEach(item => {
							const row = document.createElement("tr");
							 row.classList.add("static-row"); // Add class to identify static rows
							 

							 const firstCell = document.createElement("td");
							 firstCell.style.padding = 0;
							        firstCell.textContent = item.name;
							         row.appendChild(firstCell);

							           // Add input fields for each day
							 const period = periods[currentPeriodIndex];
							 const [startDay, startMonth, startYear] = period.start.split("/");
							 const [endDay, endMonth, endYear] = period.end.split("/");
							 let currentDate = new Date(`${startYear}-${startMonth}-${startDay}`);
							 const endDate = new Date(`${endYear}-${endMonth}-${endDay}`);

							       while (currentDate <= endDate) {
							             const cell = document.createElement("td");
							             const input = document.createElement("input");
							             input.type = "text";
							             input.style.border = "0px";
							             input.style.width = "50px";
							             input.style.outline = "none";

							              // **Set static value**
							           input.value = item.value;
							           input.readOnly = true; // Prevent user from editing the static values

							               cell.appendChild(input);
							               row.appendChild(cell);

							               currentDate.setDate(currentDate.getDate() + 1);
							         }

							           // Add total column
							    const totalCell = document.createElement("td");
								  
							           totalCell.textContent = "";
							           totalCell.classList.add("row-total");
							           row.appendChild(totalCell);

							           tableBody.appendChild(row);
							       });

							       populateDropdowns();
							   }


				  				// Function to apply dropdowns to existing rows
				 function populateDropdowns() {
					
				  			const rows = document.querySelectorAll("#tableBody tr");

				  				   rows.forEach(row => {
				  				           const firstCell = row.querySelector("td:first-child");
				  				           if (!row.classList.contains("static-row")) {
				  				               if (firstCell) {
				  				                   firstCell.innerHTML = "";
				  				                   firstCell.appendChild(createDropdown());
				  				               }
				  				           }
				  				       });
				  		}

						function updateTable() {
						    const selectedPeriod = periods[currentPeriodIndex];
						    document.getElementById('selectedPeriod').textContent = ``;

						    const [startDay, startMonth, startYear] = selectedPeriod.start.split('/');
						    const [endDay, endMonth, endYear] = selectedPeriod.end.split('/');

						    const tableHeaders = document.getElementById('tableHeaders');
						    tableHeaders.innerHTML = '<tr><th style="width: 400px;">Charge Code</th></tr>';
						    const tableRows = document.getElementById('tableBody');
						    tableRows.innerHTML = '';

						    let currentDate = new Date(`${startYear}-${startMonth}-${startDay}`);
						    const endDate = new Date(`${endYear}-${endMonth}-${endDay}`);

						    let sundayIndexes = []; // Store Sunday indexes

						    // Add date headers with day names
						    let colIndex = 1;
						    while (currentDate <= endDate) {
						        const day = currentDate.getDate();
						        const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'short' });

						        const headerCell = document.createElement('th');
						        headerCell.innerHTML = `${day}<br>${dayName}`;

						        if (dayName === "Sun") {
						            sundayIndexes.push(colIndex);
						             // Grey out Sunday headers
						        }

						        tableHeaders.querySelector('tr').appendChild(headerCell);
						        currentDate.setDate(currentDate.getDate() + 1);
						        colIndex++;
						    }

						    // Add "Total" column
						    const totalHeader = document.createElement('th');
						    totalHeader.textContent = "Total";
						    tableHeaders.querySelector('tr').appendChild(totalHeader);

						    // **Add static rows**
						    addStaticRows();

						    // **Add 3 default dynamic rows**
						    for (let i = 0; i < 1; i++) {
						        addRow();
						    }

						    // ✅ Fix: Fully grey out the entire Sunday column
						    setTimeout(() => {
						        document.querySelectorAll("#tableBody tr").forEach(row => {
						            sundayIndexes.forEach(index => {
						                let cell = row.cells[index]; // Target Sunday column
						                if (cell) {
						                    let input = cell.querySelector("input");
						                    if (input) {
						                        input.disabled = true; // Disable input on Sundays
						                        input.style.backgroundColor = "#d3d3d3"; // Grey background
						                    }
						                    cell.style.backgroundColor = "#d3d3d3"; // Ensure entire Sunday column is grey
						                }
						            });
						        });
						    }, 100);

						    // Update footer for totals
						    updateFooter(sundayIndexes);
						}


						function updateFooter(sundayIndexes) {
						    const period = periods[currentPeriodIndex];
						    const [startDay, startMonth, startYear] = period.start.split('/');
						    const [endDay, endMonth, endYear] = period.end.split('/');
						    let currentDate = new Date(`${startYear}-${startMonth}-${startDay}`);
						    const endDate = new Date(`${endYear}-${endMonth}-${endDay}`);

						    const footerRow = document.getElementById('tableFooter').querySelector('tr');

						    // ✅ Fix: Clear footer properly and ensure correct column count
						    footerRow.innerHTML = ''; // Reset footer row

						    // ✅ Fix: Add Charge Code column first to prevent misalignment
						    const chargeCodeCell = document.createElement('td');
						    chargeCodeCell.textContent = 'Total Hours';
						    footerRow.appendChild(chargeCodeCell);

						    let colIndex = 1;
						    while (currentDate <= endDate) {
						        const totalCell = document.createElement('td');

						        if (sundayIndexes.includes(colIndex)) {
						            totalCell.textContent = ""; // Remove 0.00 from Sundays
						            totalCell.style.backgroundColor = "#d3d3d3"; // Grey out Sunday footer cells
						        } else {
						            totalCell.textContent = ''; // Initialize totals
						        }

						        footerRow.appendChild(totalCell);
						        currentDate.setDate(currentDate.getDate() + 1);
						        colIndex++;
						    }

						    // ✅ Ensure total column in the footer remains aligned
						    const totalColumnFooter = document.createElement('td');
						    totalColumnFooter.textContent = '';
						    totalColumnFooter.id = 'grandTotal';
						    footerRow.appendChild(totalColumnFooter);

						    // ✅ Ensure event listeners are correctly attached
						    const inputs = document.querySelectorAll('input[type="text"]');
						    inputs.forEach(input => {
						        input.removeEventListener('input', calculateTotals); // Avoid duplicate bindings
						        input.addEventListener('input', calculateTotals);
						    });
							
							
						}




		  // Function to add a new row with dropdown
		  function addRow() {
		      const row = document.createElement("tr");

		      const projectCell = document.createElement("td");
		      projectCell.appendChild(createDropdown()); // Dropdown for charge code
		      row.appendChild(projectCell);

		      // Get selected period
		      const period = periods[currentPeriodIndex];
		      const [startDay, startMonth, startYear] = period.start.split("/");
		      const [endDay, endMonth, endYear] = period.end.split("/");
		      
		      let currentDate = new Date(`${startYear}-${startMonth}-${startDay}`);
		      const endDate = new Date(`${endYear}-${endMonth}-${endDay}`);

		      let colIndex = 1;
		      let sundayIndexes = []; // Store Sunday indexes

		      while (currentDate <= endDate) {
		          const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'short' });

		          const cell = document.createElement("td");
		          const input = document.createElement("input");
		          input.type = "text";
		          input.style.border = "0px";
		          input.style.width = "50px";
		          input.style.outline = "none";

		          if (dayName === "Sun") {
		              input.disabled = true; // Disable input on Sundays
		              input.style.backgroundColor = "#d3d3d3"; // Grey background
		              cell.style.backgroundColor = "#d3d3d3"; // Ensure entire Sunday column is grey
		              sundayIndexes.push(colIndex); // Store Sunday index
		          }

		          cell.appendChild(input);
		          row.appendChild(cell);

		          input.addEventListener("input", calculateTotals);
		          currentDate.setDate(currentDate.getDate() + 1);
		          colIndex++;
		      }

		      // Add total column
		      const totalCell = document.createElement("td");
		      totalCell.textContent = "";
		      totalCell.classList.add("row-total");
		      row.appendChild(totalCell);

		      document.getElementById("tableBody").appendChild(row);

		      // ✅ Apply Sunday disabling logic for new rows
		      setTimeout(() => {
		          sundayIndexes.forEach(index => {
		              let cell = row.cells[index];
		              if (cell) {
		                  let input = cell.querySelector("input");
		                  if (input) {
		                      input.disabled = true;
		                      input.style.backgroundColor = "#d3d3d3";
		                  }
		                  cell.style.backgroundColor = "#d3d3d3";
		              }
		          });
		      }, 100);
		  }


		  	  // Attach event listener to "Add Row" button
		  	  document.getElementById("addRow").addEventListener("click", addRow);

		  	  // Ensure static rows are added on page load
		  	  addStaticRows();

		  	  // Fetch charge codes & populate existing table
		  	  fetchChargeCodes();
			  
			  
			  function calculateTotals() {
			      let grandTotal = 0;
			      const rows = document.querySelectorAll('#tableBody tr');
			      const footerCells = document.querySelectorAll('#tableFooter tr td');

			      const period = periods[currentPeriodIndex];
			      const [startDay, startMonth, startYear] = period.start.split('/');
			      const [endDay, endMonth, endYear] = period.end.split('/');

			      let currentDate = new Date(`${startYear}-${startMonth}-${startDay}`);
			      const endDate = new Date(`${endYear}-${endMonth}-${endDay}`);

			      let totalDays = 0;
			      while (currentDate <= endDate) {
			          totalDays++;
			          currentDate.setDate(currentDate.getDate() + 1);
			      }

			      // ✅ Ensure total array matches the number of date columns
			      const totals = new Array(totalDays).fill(0);

			      rows.forEach((row, rowIndex) => {
			          if (row.classList.contains("static-row")) return; // Skip static rows

			          const inputs = row.querySelectorAll('td input[type="text"]');
			          let rowSum = 0;

			          inputs.forEach((input, index) => {
			              const value = parseFloat(input.value) || 0;
			              totals[index] += value; // ✅ Fix: Do not subtract 1 from index
			              rowSum += value;
			          });

			          // ✅ Fix: Use correct column for row total
			          const totalCell = row.querySelector('.row-total');
			          if (totalCell) {
			              totalCell.textContent = rowSum.toFixed(2);
			          }

			          grandTotal += rowSum;
			      });

			      // ✅ Update the footer cells correctly
			      totals.forEach((total, index) => {
			          if (footerCells[index + 1]) {
			              footerCells[index + 1].textContent = total.toFixed(2);
			          }
			      });

			      // ✅ Ensure grand total column updates correctly
			      const grandTotalCell = document.getElementById('grandTotal');
			      if (grandTotalCell) {
			          grandTotalCell.textContent = grandTotal.toFixed(2);
			      }
			  }

			  // ✅ Ensure this function runs when new rows are added
			  document.getElementById('addRow').addEventListener('click', () => {
			     
			      calculateTotals(); // Recalculate totals after adding rows
			  });

			  // ✅ Run calculateTotals after initializing the table
			  updateTable();
			  calculateTotals();


		          function updateDropdowns() {
		              const selects = document.querySelectorAll('select');
		              const selectedValues = [...selects].map(select => select.value).filter(val => val !== '');

		              selects.forEach(select => {
		                  [...select.options].forEach(option => {
		                      if (selectedValues.includes(option.value) && option.value !== select.value) {
		                          option.disabled = true;
		                      } else {
		                          option.disabled = false;
		                      }
		                  });
		              });
		          }

		          document.getElementById('prevPeriod').addEventListener('click', function() {
		              if (currentPeriodIndex > 0) {
		                  currentPeriodIndex--;
		                  updateDropdown();
		                  updateTable();
						  
		              }
		          });

		          document.getElementById('nextPeriod').addEventListener('click', function() {
		              if (currentPeriodIndex < periods.length - 1) {
		                  currentPeriodIndex++;
		                  updateDropdown();
		                  updateTable();
		              }
		          });

		          document.getElementById('periodDropdown').addEventListener('change', function() {
		              currentPeriodIndex = parseInt(this.value);
		              updateTable();
		          });

		          document.getElementById('calendarPicker').addEventListener('change', function() {
		              const selectedDate = new Date(this.value);
		              for (let i = 0; i < periods.length; i++) {
		                  const [startDay, startMonth, startYear] = periods[i].start.split('/');
		                  const [endDay, endMonth, endYear] = periods[i].end.split('/');
		                  const periodStart = new Date(`${startYear}-${startMonth}-${startDay}`);
		                  const periodEnd = new Date(`${endYear}-${endMonth}-${endDay}`);

		                  if (selectedDate >= periodStart && selectedDate <= periodEnd) {
		                      currentPeriodIndex = i;
		                      updateDropdown();
		                      updateTable();
		                      break;
		                  }
		              }
		          });

		          document.getElementById('calendarPicker').value = today.toISOString().split('T')[0];
		          setCalendarLimits();
		          updateDropdown();
		          updateTable();
		          document.getElementById('addRow').addEventListener('click', addRow);
				  
				  
				  /*Notification script*/
				  document.addEventListener("DOMContentLoaded", function () {
				      let stompClient = null;
				      let notificationCount = 0;

				      function connectWebSocket() {
				          const socket = new SockJS('/ws');
				          stompClient = Stomp.over(socket);

				          stompClient.connect({}, function () {
				              console.log("Connected to WebSocket");

				              // ✅ Admin Panel: Listen for notifications
				              stompClient.subscribe('/topic/adminNotifications', function (notification) {
				                  const message = JSON.parse(notification.body).message;
				                  showNotification(message, "admin");
				              });

				              // ✅ Employee Panel: Listen for user-specific notifications
				              const userName = localStorage.getItem("userName");  // Get logged-in user
				              if (userName) {
				                  stompClient.subscribe(`/user/${userName}/topic/notifications`, function (notification) {
				                      const message = JSON.parse(notification.body).message;
				                      showNotification(message, "employee");
				                  });
				              }
							
				          });
				      }

				      function showNotification(message, panelType) {
				          const bellIcon = document.getElementById("notificationBell");
				          const badge = document.getElementById("notificationCount");
				          const notificationList = document.getElementById("notificationList");

				          if (!badge || !notificationList) return; // Ensure elements exist

				          notificationCount++; // Increment badge count
				          badge.style.display = "inline";  // Show badge
				          badge.textContent = notificationCount; // Update count

				          // Create notification entry
				          const notificationItem = document.createElement("div");
				          notificationItem.className = "dropdown-item";
				          notificationItem.textContent = message;

				          // Add to list
				          notificationList.prepend(notificationItem);
				      }

				      function toggleNotifications() {
				          const dropdown = document.getElementById("notificationDropdown");
				          dropdown.classList.toggle("show");
				          notificationCount = 0;  // Reset count when viewed
				          document.getElementById("notificationCount").style.display = "none";
				      }

					  
				      // Attach click event to bell icon
				      document.getElementById("notificationBell").addEventListener("click", toggleNotifications);

					
				      // Connect WebSocket
				      connectWebSocket();
				  });

				  
				
</script>
 </body>
 </html>