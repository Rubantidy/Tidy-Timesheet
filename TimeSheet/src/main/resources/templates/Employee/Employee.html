<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timesheet</title>
  <!--  <link rel="stylesheet" href="style.css"> -->
	<script src="/Employee/script.js"></script>
	<link rel="stylesheet" href="/Employee/style.css">
    
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>



</head>
<body class="time-body">  
    
    <!-- Section 1: Header -->
    <div class="header-section d-flex justify-content-between align-items-center p-3 bg-light border-bottom">
        <h2 class="m-0">myTimesheet</h2>
		<div class="iconsmenu">
						    <i class="bi bi-bell"></i>

						    <i class="bi bi-person-circle" id="userIcon" onclick="toggleDropdown()"></i>
							<span id="userName" style="color: black; margin-left: 10px; display: none;"></span>
							

						    <div id="userDropdown" class="dropdown-menu">
						        <a href="#" class="dropdown-item">Change Password</a>
						        <a href="#" class="dropdown-item">Switch Admin</a>
								<a href="#" class="dropdown-item" id="logout">Logout</a>
						    </div>
						</div>
    </div>

	<!-- Change Password Modal -->
	<div class="modal" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
	    <div class="modal-dialog">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="changePasswordModalLabel">Change Your Password</h5>
	                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	            </div>
	            <div class="modal-body">
	                <form>
	                    <div class="mb-3">
	                        <label for="newPassword" class="form-label">New Password</label>
	                        <input type="password" class="form-control" id="newPassword" placeholder="Enter your new password" required>
	                        <div id="passwordError" style="color: red; display: none;"></div>
	                    </div>
	                    <div class="mb-3">
	                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
	                        <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm your new password" required>
	                    </div>
	                </form>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
	                <button type="button" class="btn btn-primary" id="sendOtpBtn">Send OTP</button>
	            </div>
	        </div>
	    </div>
	</div>



	<!-- OTP Modal -->
	<div class="modal" id="otpModal" tabindex="-1" aria-labelledby="otpModalLabel" aria-hidden="true">
	    <div class="modal-dialog">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="otpModalLabel">Enter OTP</h5>
	                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	            </div>
	            <div class="modal-body">
	                <form>
	                    <div class="mb-3">
	                        <label for="otp" class="form-label">One-Time Password (OTP)</label>
	                        <input type="text" class="form-control" id="otp" placeholder="Enter the OTP sent to your email" required>
	                        <div id="otpError" style="color: red; display: none;"></div>
	                    </div>
	                </form>
	                <!-- Timer Display -->
	                <div id="timerDisplay" style="margin-top: 10px;"></div>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
	                <button type="button" class="btn btn-primary" id="changePasswordBtn">Change Password</button>
	                <button type="button" class="btn btn-warning" id="resendOtpBtn" style="display: none;">Resend OTP</button>
	            </div>
	        </div>
	    </div>
	</div>

	
    <!-- Section 2: Navigation -->
    <div class="navigation-section d-flex p-2 bg-white border-bottom align-items-center">
        <ul class="nav flex-grow-1">
            <li class="nav-item"><a class="nav-link" data-target="timeSection" href="#">Time</a></li>
            <li class="nav-item"><a class="nav-link" data-target="expenseSection" href="#">Expense</a></li>
            <li class="nav-item"><a class="nav-link" data-target="locationSection" href="#">Location</a></li>
            <li class="nav-item"><a class="nav-link" data-target="chargecodesSection" href="#">Charge Codes</a></li>
            <li class="nav-item"><a class="nav-link" data-target="adjustmentSection" href="#">Adjustment</a></li>
            <li class="nav-item"><a class="nav-link" data-target="summarySection" href="#">Summary</a></li>
            <li class="nav-item"><a class="nav-link" data-target="preferenceSection" href="#">Preference</a></li>
        </ul>
    
        <!-- Date Controls -->
         <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm" id="prevPeriod"><</button>
            <select class="form-select form-select-sm w-auto" id="periodDropdown"></select>
            <button class="btn btn-sm" id="nextPeriod">></button>
            <input type="date" class="form-control form-control-sm w-auto" id="calendarPicker">
            
            <!-- Printer Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="25" fill="currentColor" class="bi bi-printer-fill" viewBox="0 0 16 16">
                <path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1"/>
                <path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2zm2.5 1a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"/>
            </svg>
        </div>
    </div>

    <!-- Section 3: Controls -->
    <div class="controls-section d-flex justify-content-between align-items-center p-3 bg-light border-bottom">
        <div class="d-flex gap-3">
            <!-- Save Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-floppy-fill" viewBox="0 0 16 16">
                <path d="M0 1.5A1.5 1.5 0 0 1 1.5 0H3v5.5A1.5 1.5 0 0 0 4.5 7h7A1.5 1.5 0 0 0 13 5.5V0h.086a1.5 1.5 0 0 1 1.06.44l1.415 1.414A1.5 1.5 0 0 1 16 2.914V14.5a1.5 1.5 0 0 1-1.5 1.5H14v-5.5A1.5 1.5 0 0 0 12.5 9h-9A1.5 1.5 0 0 0 2 10.5V16h-.5A1.5 1.5 0 0 1 0 14.5z"/>
                <path d="M3 16h10v-5.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5zm9-16H4v5.5a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5zM9 1h2v4H9z"/>
            </svg>
    
            <!-- Delete Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
            </svg>
    
            <!-- Add Row Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" id="addRow" width="26" height="26" fill="currentColor" class="bi bi-plus-circle-dotted" viewBox="0 0 16 16">
                <path d="M8 0q-.264 0-.523.017l.064.998a7 7 0 0 1 .918 0l.064-.998A8 8 0 0 0 8 0M6.44.152q-.52.104-1.012.27l.321.948q.43-.147.884-.237L6.44.153zm4.132.271a8 8 0 0 0-1.011-.27l-.194.98q.453.09.884.237zm1.873.925a8 8 0 0 0-.906-.524l-.443.896q.413.205.793.459zM4.46.824q-.471.233-.905.524l.556.83a7 7 0 0 1 .793-.458zM2.725 1.985q-.394.346-.74.74l.752.66q.303-.345.648-.648zm11.29.74a8 8 0 0 0-.74-.74l-.66.752q.346.303.648.648zm1.161 1.735a8 8 0 0 0-.524-.905l-.83.556q.254.38.458.793l.896-.443zM1.348 3.555q-.292.433-.524.906l.896.443q.205-.413.459-.793zM.423 5.428a8 8 0 0 0-.27 1.011l.98.194q.09-.453.237-.884zM15.848 6.44a8 8 0 0 0-.27-1.012l-.948.321q.147.43.237.884zM.017 7.477a8 8 0 0 0 0 1.046l.998-.064a7 7 0 0 1 0-.918zM16 8a8 8 0 0 0-.017-.523l-.998.064a7 7 0 0 1 0 .918l.998.064A8 8 0 0 0 16 8M.152 9.56q.104.52.27 1.012l.948-.321a7 7 0 0 1-.237-.884l-.98.194zm15.425 1.012q.168-.493.27-1.011l-.98-.194q-.09.453-.237.884zM.824 11.54a8 8 0 0 0 .524.905l.83-.556a7 7 0 0 1-.458-.793zm13.828.905q.292-.434.524-.906l-.896-.443q-.205.413-.459.793zm-12.667.83q.346.394.74.74l.66-.752a7 7 0 0 1-.648-.648zm11.29.74q.394-.346.74-.74l-.752-.66q-.302.346-.648.648zm-1.735 1.161q.471-.233.905-.524l-.556-.83a7 7 0 0 1-.793.458zm-7.985-.524q.434.292.906.524l.443-.896a7 7 0 0 1-.793-.459zm1.873.925q.493.168 1.011.27l.194-.98a7 7 0 0 1-.884-.237zm4.132.271a8 8 0 0 0 1.012-.27l-.321-.948a7 7 0 0 1-.884.237l.194.98zm-2.083.135a8 8 0 0 0 1.046 0l-.064-.998a7 7 0 0 1-.918 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3z"/>
            </svg>
        </div>

    
        <div class="col-6 d-flex justify-content-end gap-3 ">
              
            <button class="btn btn-success">Send Approval</button>
            <button class="btn btn-info">Submit</button>
        </div>
    </div>

    <p id="selectedPeriod">Selected Period:</p>
    <div id="timeSection" class="content-section">
        <table class="table table-bordered">
            <thead id="tableHeaders">
                <tr></tr>
            </thead>
            <tbody id="tableBody"></tbody>
            <tfoot id="tableFooter">
                <tr></tr>
            </tfoot>
        </table>
    </div>


<!-- Section for Expense -->
<div id="expenseSection" class="content-section" style="display: none;">
    <h3>Expense Section</h3>
    <p>This is where expense details will go.</p>
</div>

<!-- Section for Location -->
<div id="locationSection" class="content-section" style="display: none;">
    <h3>Location Section</h3>
    <p>This is where location details will go.</p>
</div>


	
<!-- Section for Charge Codes in Employee Page -->
<div id="chargecodesSection" class="content-section container-fluid mt-4" style="display: none; padding: 20px;">
    
    <!-- Header Section with Sorting Dropdown -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="text-primary">Charge Code List</h3>
        <select id="projectTypeFilter" class="form-select w-auto">
            <option value="All">All</option>
            <option value="External">External</option>
            <option value="Internal">Internal</option>
        </select>
    </div>
    
    <div class="table-responsive">
        <table class="table table-hover table-bordered w-100">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Code Type</th>
                    <th>Code</th>
                    <th>Client Name</th>
                    <th>Description</th>
                    <th>Project Type</th>
                    <th>Start Date</th>
                    <th>Country</th>
                </tr>
            </thead>
            <tbody id="employee-code-table-body" class="table-group-divider"></tbody>
        </table>
    </div>
</div>


	
<!-- Section for Adjustment -->
<div id="adjustmentSection" class="content-section" style="display: none;">
    <h3>Adjustment Section</h3>
    <p>This is where adjustments will go.</p>
</div>

<!-- Section for Summary -->
<div id="summarySection" class="content-section" style="display: none;">
    <h3>Summary Section</h3>
    <p>This is the summary of your timesheet.</p>
</div>

<!-- Section for Preference -->
<div id="preferenceSection" class="content-section" style="display: none;">
    <h3>Preference Section</h3>
    <p>This is where you can adjust your preferences.</p>
</div>



<script>
	
	document.addEventListener("DOMContentLoaded", function () {
	           const newDropdown = document.querySelector(".customDropdown");
	           newDropdown.addEventListener("change", function () {
	               console.log("Selected value:", newDropdown.value);
	           });
	       });
		   
		   
	document.addEventListener("DOMContentLoaded", function () {
	    const saveIcon = document.querySelector(".bi-floppy-fill");
	    const deleteIcon = document.querySelector(".bi-trash");
	    const addRowIcon = document.getElementById("addRow");

	    function updateIcons() {
	        const activeSection = document.querySelector(".content-section:not([style*='display: none'])");

	        if (!activeSection) return; // No active section, do nothing

	        // **Show/Hide Icons Instead of Removing Them**
	        if (activeSection.id === "timeSection") {
	            saveIcon.style.display = "inline-block";
	            deleteIcon.style.display = "inline-block";
	            addRowIcon.style.display = "inline-block"; // Keep addRow functional
	        } else if (activeSection.id === "locationSection" || activeSection.id === "preferenceSection") {
	            saveIcon.style.display = "inline-block";
	            deleteIcon.style.display = "inline-block";
	            addRowIcon.style.display = "none"; // Hide addRow but keep it in DOM
	        } else {
	            saveIcon.style.display = "none";
	            deleteIcon.style.display = "none";
	            addRowIcon.style.display = "none";
	        }
	    }

	    // Attach event listener to navigation links
	    document.querySelectorAll(".nav-link").forEach(link => {
	        link.addEventListener("click", function () {
	            setTimeout(updateIcons, 100); // Delay for smooth transition
	        });
	    });

	    // Run initially
	    updateIcons();
	});




	          document.addEventListener("DOMContentLoaded", function() {
		
	          const userName = localStorage.getItem('userName');
	          console.log(userName); // Debugging: Check if the value is correct

	          if (userName) {
	              const userNameElement = document.getElementById('userName');
	              userNameElement.innerText = userName;
	              userNameElement.style.display = 'inline'; // Show the name under the icon
	          }
	      });

		  // Function to toggle the dropdown menu visibility
		  function toggleDropdown() { 
		      const dropdown = document.getElementById('userDropdown');
		      dropdown.style.display = (dropdown.style.display === 'block') ? 'none' : 'block';
		  }


		  document.addEventListener('click', function(event) {
		      const dropdown = document.getElementById('userDropdown');
		      const userIcon = document.getElementById('userIcon');
		      if (!userIcon.contains(event.target) && !dropdown.contains(event.target)) {
		          dropdown.style.display = 'none';
		      }
		  });
		  

		  /*change password with otp*/
		  		
		  		let otp; // This will store the OTP sent to the email
		  		let otpTimer; // To store the timer for OTP expiration
		  		let countdown = 120; // 2 minutes countdown in seconds

		  		// Function to update the timer display
		  		function updateTimerDisplay() {
		  		    const timerDisplay = document.getElementById('timerDisplay');
		  		    if (timerDisplay) {
		  		        const minutes = Math.floor(countdown / 60);
		  		        const seconds = countdown % 60;
		  		        timerDisplay.innerText = `Time remaining: ${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
		  		    }
		  		}

		  		// Event listener for opening the change password modal
		  		document.getElementById('userDropdown').addEventListener('click', function (e) {
		  		    if (e.target.innerText === 'Change Password') {
		  		        // Open the modal when 'Change Password' is clicked
		  		        var changePasswordModal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
		  		        changePasswordModal.show();
		  		    }
		  		});

		  		// Send OTP when the "Send OTP" button is clicked
		  		document.getElementById('sendOtpBtn').addEventListener('click', function () {
		  		    const newPassword = document.getElementById('newPassword').value;
		  		    const confirmPassword = document.getElementById('confirmPassword').value;
		  		    const passwordError = document.getElementById('passwordError');
		  		    
		  		    // Hide previous error message
		  		    passwordError.style.display = 'none';

		  		    // Validate password fields
		  		    if (!newPassword || !confirmPassword) {
		  		        passwordError.style.display = 'block';
		  		        passwordError.innerHTML = "Both fields are required.";
		  		        return;
		  		    }

		  		    if (newPassword !== confirmPassword) {
		  		        passwordError.style.display = 'block';
		  		        passwordError.innerHTML = "Passwords do not match.";
		  		        return;
		  		    }

		  		    // Send the request to the backend to send OTP to the user's email
		  		    const email = localStorage.getItem('userName');  // Get the email of the logged-in user

		  		    fetch("/send-otp", {
		  		        method: "POST",
		  		        headers: {
		  		            "Content-Type": "application/json"
		  		        },
		  		        body: JSON.stringify({ email: email })
		  		    })
		  		    .then(response => response.json())
		  		    .then(result => {
		  		        if (result.success) {
		  		            otp = result.otp;  // Store the OTP
		  		            var otpModal = new bootstrap.Modal(document.getElementById('otpModal'));
		  		            otpModal.show();

		  		            // Start the countdown timer
		  		            countdown = 120; // Reset countdown to 2 minutes
		  		            updateTimerDisplay();
		  		            otpTimer = setInterval(function() {
		  		                countdown--;
		  		                updateTimerDisplay();
		  		                if (countdown <= 0) {
		  		                    clearInterval(otpTimer);
		  		                    document.getElementById('sendOtpBtn').style.display = 'none'; // Hide Send OTP button
		  		                    document.getElementById('resendOtpBtn').style.display = 'inline-block'; // Show Resend OTP button
		  		                }
		  		            }, 1000);

		  		        } else {
		  		            alert("Failed to send OTP. Please try again.");
		  		        }
		  		    })
		  		    .catch(error => {
		  		        console.error("Error:", error);
		  		        alert("An error occurred. Please try again later.");
		  		    });
		  		});

		  		// Resend OTP functionality
		  		document.getElementById('resendOtpBtn').addEventListener('click', function() {
		  		    // Trigger the same functionality as the "Send OTP" button
		  		    document.getElementById('sendOtpBtn').click();
		  		    // Hide the Resend OTP button after clicking
		  		    document.getElementById('resendOtpBtn').style.display = 'none';
		  		});

		  		// Change password after OTP validation
		  		document.getElementById('changePasswordBtn').addEventListener('click', function () {
		  		    const enteredOtp = document.getElementById('otp').value;
		  		    const otpError = document.getElementById('otpError');

		  		    otpError.style.display = 'none';

		  		    // Validate OTP
		  		    if (!enteredOtp) {
		  		        otpError.style.display = 'block';
		  		        otpError.innerHTML = "OTP is required.";
		  		        return;
		  		    }

		  		    // Send the OTP and password to the backend for validation
		  		    const newPassword = document.getElementById('newPassword').value;

		  		    fetch("/change-password", {
		  		        method: "POST",
		  		        headers: {
		  		            "Content-Type": "application/json"
		  		        },
		  		        body: JSON.stringify({
		  		            email: localStorage.getItem('userName'),
		  		            newPassword: newPassword,
		  		            otp: enteredOtp
		  		        })
		  		    })
		  		    .then(response => response.json())
		  		    .then(result => {
		  		        if (result.success) {
		  		            alert("Your password was changed successfully.");

		  		            // Close the OTP modal (password change form)
		  		            var otpModal = bootstrap.Modal.getInstance(document.getElementById('otpModal'));
		  		            otpModal.hide();  // Hide the OTP modal after successful password change
		  					
		  					// Close the Change Password modal (in case it is still open)
		  					          var changePasswordModal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
		  					          changePasswordModal.hide();  // Hide the Change Password modal as well

		  		            // Reset the OTP field and form for clean state
		  		            document.getElementById('otp').value = '';
		  		            document.getElementById('newPassword').value = '';
		  		            document.getElementById('confirmPassword').value = '';

		  		            // Optional: Hide the Resend OTP button again, in case the modal is reopened
		  		            document.getElementById('resendOtpBtn').style.display = 'none';
		  		            document.getElementById('sendOtpBtn').style.display = 'inline-block';
		  		        } else {
		  		            console.log("Error response:", result); // Debug log to check the response from backend
		  		            alert("Failed to change the password. Please try again.");
		  		        }
		  		    })
		  		    .catch(error => {
		  		        console.error("Error:", error);
		  		        alert("An error occurred. Please try again later.");
		  		    });
		  		});

				
				/*script for logout*/
				document.getElementById('logout').addEventListener('click', function(event) {
				       event.preventDefault();

				       // Clear any session or localStorage data if needed
				       localStorage.removeItem('userName'); // Example of clearing the user name stored in localStorage

				       // Redirect to the login page
				       window.location.href = '/login'; // Redirect to the login page or wherever needed
					   alert("Logout Successfully..! ");
				   });
				
				
				
				   /*script for swtching role*/
				   
				   document.querySelector('.dropdown-menu').addEventListener('click', function(event) {
				       event.preventDefault();

				       // Check if the clicked item is 'Switch Admin'
				       if (event.target.innerText === 'Switch Admin') {
				           const userEmail = localStorage.getItem('userEmail');  // Fetch the email from localStorage

				           if (!userEmail) {
				               alert("User is not logged in. Please log in first.");
				               return;
				           }

				           // Send the email to backend to check if the user can switch to Admin
				           fetch('/check-admin-role', {
				               method: 'POST',
				               headers: {
				                   'Content-Type': 'application/json'
				               },
				               body: JSON.stringify({ email: userEmail })
				           })
				           .then(response => response.json())
				           .then(data => {
				               if (data.success) {
				                   // The user is authorized to switch to Admin panel
				                   localStorage.setItem('userName', data.eName);  // Store the new name (from Admin or Delegator)
				                   localStorage.setItem('userRole', "Admin");  // Update role to Admin
				                   
				                   // Redirect to Admin Dashboard
				                   window.location.href = "/Admin_Dashboard";
				               } else {
				                   alert("You do not have permission to switch to the Admin panel.");
				               }
				           })
				           .catch(error => {
				               console.error("Error:", error);
				               alert("An error occurred. Please try again.");
				           });
				       }
				   });

				       
						
		  /*script for calender*/
		  
		  const today = new Date();
		          let currentYear = today.getFullYear();
		          let currentMonth = today.getMonth() + 1;
		          let currentPeriodIndex = 0; 
		          let availableProjects = ['Project A', 'Project B', 'Project C', 'Project D', 'Project E','Project f'];

		          function formatDate(date) {
		              const year = date.getFullYear();
		              const month = (`0${date.getMonth() + 1}`).slice(-2); // Add leading zero
		              const day = (`0${date.getDate()}`).slice(-2); // Add leading zero
		              return `${year}-${month}-${day}`;
		          }

		          function setCalendarLimits() {
		              const threeMonthsBefore = new Date(today);
		              threeMonthsBefore.setMonth(today.getMonth() - 3);
		              
		              const threeMonthsAfter = new Date(today);
		              threeMonthsAfter.setMonth(today.getMonth() + 3);
		              
		              const calendarPicker = document.getElementById('calendarPicker');
		              calendarPicker.min = formatDate(threeMonthsBefore);
		              calendarPicker.max = formatDate(threeMonthsAfter);
		          }

		          function getPeriods() {
		              const periods = [];
		              const baseDate = new Date(today);
		              
		              // Loop to create periods for 3 months before and 3 months after the current date
		              for (let i = -3; i <= 3; i++) {
		                  const monthOffset = new Date(baseDate.getFullYear(), baseDate.getMonth() + i, 1);
		                  const firstHalf = {
		                      start: `01/${(`0${monthOffset.getMonth() + 1}`).slice(-2)}/${monthOffset.getFullYear()}`,
		                      end: `15/${(`0${monthOffset.getMonth() + 1}`).slice(-2)}/${monthOffset.getFullYear()}`
		                  };
		                  const lastDayOfMonth = new Date(monthOffset.getFullYear(), monthOffset.getMonth() + 1, 0).getDate();
		                  const secondHalf = {
		                      start: `16/${(`0${monthOffset.getMonth() + 1}`).slice(-2)}/${monthOffset.getFullYear()}`,
		                      end: `${lastDayOfMonth}/${(`0${monthOffset.getMonth() + 1}`).slice(-2)}/${monthOffset.getFullYear()}`
		                  };
		                  
		                  periods.push(firstHalf, secondHalf);
		              }

		              const todayDate = `${today.getDate()}/${today.getMonth() + 1 < 10 ? '0' + (today.getMonth() + 1) : today.getMonth() + 1}/${today.getFullYear()}`;
		              periods.forEach((period, index) => {
		                  if (isDateInRange(todayDate, period.start, period.end)) {
		                      currentPeriodIndex = index;
		                  }
		              });
		              
		              return periods;
		          }

		          function isDateInRange(date, startDate, endDate) {
		              const [dDay, dMonth, dYear] = date.split('/');
		              const [sDay, sMonth, sYear] = startDate.split('/');
		              const [eDay, eMonth, eYear] = endDate.split('/');
		              const dateObj = new Date(dYear, dMonth - 1, dDay);
		              const startObj = new Date(sYear, sMonth - 1, sDay);
		              const endObj = new Date(eYear, eMonth - 1, eDay);
		              return dateObj >= startObj && dateObj <= endObj;
		          }
		          const periods = getPeriods();

		          function updateDropdown() {
		              const periodDropdown = document.getElementById('periodDropdown');
		              periodDropdown.innerHTML = '';
		              periods.forEach((period, index) => {
		                  const option = document.createElement('option');
		                  option.value = index;
		                  option.textContent = `${period.start} - ${period.end}`;
		                  if (index === currentPeriodIndex) {
		                      option.selected = true;
		                  }
		                  periodDropdown.appendChild(option);
		              });
		          }


				  let chargeCodes = [];

				  			   // Fetch charge codes from backend
				  			   function fetchChargeCodes() {
				  			       fetch("/getChargecodes")
				  			           .then(response => response.json())
				  			           .then(data => {
				  			               chargeCodes = data;
				  			               populateDropdowns(); // Populate static + new rows
				  			           })
				  			           .catch(error => console.error("Error fetching Charge codes:", error));
				  			   }

				  			   // Function to create a custom dropdown with search & scrolling
				  			   function createDropdown() {
				  			       const container = document.createElement("div");
				  			       container.classList.add("dropdown-container");

				  			       const button = document.createElement("div");
				  			       button.classList.add("dropdown-button");
				  			       button.textContent = "Select Charge Code";

				  			       const panel = document.createElement("div");
				  			       panel.classList.add("dropdown-panel");

				  			       const searchInput = document.createElement("input");
				  			       searchInput.type = "text";
				  			       searchInput.placeholder = "Search...";
				  			       searchInput.classList.add("dropdown-search");

				  			       panel.appendChild(searchInput);

				  			       chargeCodes.forEach(code => {
				  			           const option = document.createElement("div");
				  			           option.classList.add("dropdown-option");
				  			           option.textContent = `${code.code} - ${code.description}`;
				  			           option.dataset.value = code.code;

				  			           // Handle selection
				  			           option.addEventListener("click", function () {
				  			               button.textContent = option.textContent;
				  			               panel.style.display = "none";
				  			           });

				  			           panel.appendChild(option);
				  			       });

				  			       // Handle search functionality
				  			       searchInput.addEventListener("input", function () {
				  			           const filter = searchInput.value.toLowerCase();
				  			           const options = panel.querySelectorAll(".dropdown-option");
				  			           options.forEach(option => {
				  			               if (option.textContent.toLowerCase().includes(filter)) {
				  			                   option.style.display = "block";
				  			               } else {
				  			                   option.style.display = "none";
				  			               }
				  			           });
				  			       });

				  			       // Toggle dropdown visibility
				  			       button.addEventListener("click", function () {
				  			           panel.style.display = panel.style.display === "block" ? "none" : "block";
				  			       });

				  				   // Close dropdown when clicking outside
				  				         document.addEventListener("click", function (event) {
				  				             if (!container.contains(event.target)) {
				  				                 panel.style.display = "none";
				  				             }
				  				         });
				  						 
				  			       container.appendChild(button);
				  			       container.appendChild(panel);
				  			       return container;
				  			   }


				  			    // Add static rows (Work Location & Company Code)
				  			    function addStaticRows() {
				  			        const tableBody = document.getElementById("tableBody");
				  			        const staticRowNames = ["Work Location", "Company Code"];

				  			        staticRowNames.forEach(name => {
				  			            const row = document.createElement("tr");
				  			            row.classList.add("static-row"); // Add class to identify static rows

				  			            const firstCell = document.createElement("td");
				  			            firstCell.textContent = name;
				  			            row.appendChild(firstCell);

				  			            // Add input fields for each day
				  			            const period = periods[currentPeriodIndex];
				  			            const [startDay, startMonth, startYear] = period.start.split("/");
				  			            const [endDay, endMonth, endYear] = period.end.split("/");
				  			            let currentDate = new Date(`${startYear}-${startMonth}-${startDay}`);
				  			            const endDate = new Date(`${endYear}-${endMonth}-${endDay}`);

				  			            while (currentDate <= endDate) {
				  			                const cell = document.createElement("td");
				  			                const input = document.createElement("input");
				  			                input.type = "text";
				  			                input.style.border = "0px";
				  			                input.style.width = "50px";
				  			                input.style.outline = "none";
				  			                cell.appendChild(input);
				  			                row.appendChild(cell);

				  			                input.addEventListener("input", calculateTotals);
				  			                currentDate.setDate(currentDate.getDate() + 1);
				  			            }

				  			            // Add total column
				  			            const totalCell = document.createElement("td");
				  			            totalCell.textContent = "0.00";
				  			            totalCell.classList.add("row-total");
				  			            row.appendChild(totalCell);

				  			            tableBody.appendChild(row);
				  			        });
				  					populateDropdowns();
				  			    }

				  				// Function to apply dropdowns to existing rows
				  				   function populateDropdowns() {
				  				       const rows = document.querySelectorAll("#tableBody tr");

				  				       rows.forEach(row => {
				  				           const firstCell = row.querySelector("td:first-child");
				  				           if (!row.classList.contains("static-row")) {
				  				               if (firstCell) {
				  				                   firstCell.innerHTML = "";
				  				                   firstCell.appendChild(createDropdown());
				  				               }
				  				           }
				  				       });
				  				   }

		  function updateTable() {
		      const selectedPeriod = periods[currentPeriodIndex];
		      document.getElementById('selectedPeriod').textContent = ``;
		      
		      const [startDay, startMonth, startYear] = selectedPeriod.start.split('/');
		      const [endDay, endMonth, endYear] = selectedPeriod.end.split('/');

		      const tableHeaders = document.getElementById('tableHeaders');
		      tableHeaders.innerHTML = '<tr><th style="width: 200px;">Charge Code</th></tr>'; // Set width for Charge Code
		      const tableRows = document.getElementById('tableBody');
		      tableRows.innerHTML = ''; // Clear existing rows

		      let currentDate = new Date(`${startYear}-${startMonth}-${startDay}`);
		      const endDate = new Date(`${endYear}-${endMonth}-${endDay}`);

		      // Add date headers with day names
		      while (currentDate <= endDate) {
		          const day = currentDate.getDate();
		          const month = currentDate.getMonth() + 1;
		          const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'short' });

		          const headerCell = document.createElement('th');
		          headerCell.textContent = `${day}/${month} (${dayName})`;
		          tableHeaders.querySelector('tr').appendChild(headerCell);

		          currentDate.setDate(currentDate.getDate() + 1);
		      }

		      // **Add "Total" column to the header**
		      const totalHeader = document.createElement('th');
		      totalHeader.textContent = "Total";
		      tableHeaders.querySelector('tr').appendChild(totalHeader);

		      // Add static rows
		      addStaticRows();

		      // Add 3 default dynamic rows
		      for (let i = 0; i < 3; i++) {
		          addRow();
		      }

		      // Update footer for totals
		      updateFooter();
		  }


		  function updateFooter() {
		      const period = periods[currentPeriodIndex];
		      const [startDay, startMonth, startYear] = period.start.split('/');
		      const [endDay, endMonth, endYear] = period.end.split('/');
		      let currentDate = new Date(`${startYear}-${startMonth}-${startDay}`);
		      const endDate = new Date(`${endYear}-${endMonth}-${endDay}`);

		      const footerRow = document.getElementById('	').querySelector('tr');
		      footerRow.innerHTML = '<td>Total Hours</td>'; // Reset footer row

		      while (currentDate <= endDate) {
		          const totalCell = document.createElement('td');
		          totalCell.textContent = '0.00'; // Initialize totals
		          footerRow.appendChild(totalCell);
		          currentDate.setDate(currentDate.getDate() + 1);
		      }

		      // **Ensure total column in the footer**
		      const totalColumnFooter = document.createElement('td');
		      totalColumnFooter.textContent = '0.00';
		      totalColumnFooter.id = 'grandTotal';
		      footerRow.appendChild(totalColumnFooter);

		      // Attach event listeners to all input fields for dynamic updates
		      const inputs = document.querySelectorAll('input[type="text"]');
		      inputs.forEach(input => {
		          input.addEventListener('input', calculateTotals);
		      });
		  }

		  // Function to add a new row with dropdown
		  	  function addRow() {
		  	      const row = document.createElement("tr");

		  	      const projectCell = document.createElement("td");
		  	      projectCell.appendChild(createDropdown()); // Dropdown for charge code
		  	      row.appendChild(projectCell);

		  	      // Add input fields for each day
		  	      const period = periods[currentPeriodIndex];
		  	      const [startDay, startMonth, startYear] = period.start.split("/");
		  	      const [endDay, endMonth, endYear] = period.end.split("/");
		  	      let currentDate = new Date(`${startYear}-${startMonth}-${startDay}`);
		  	      const endDate = new Date(`${endYear}-${endMonth}-${endDay}`);

		  	      while (currentDate <= endDate) {
		  	          const cell = document.createElement("td");
		  	          const input = document.createElement("input");
		  	          input.type = "text";
		  	          input.style.border = "0px";
		  	          input.style.width = "50px";
		  	          input.style.outline = "none";
		  	          cell.appendChild(input);
		  	          row.appendChild(cell);

		  	          input.addEventListener("input", calculateTotals);
		  	          currentDate.setDate(currentDate.getDate() + 1);
		  	      }

		  	      // Add total column
		  	      const totalCell = document.createElement("td");
		  	      totalCell.textContent = "0.00";
		  	      totalCell.classList.add("row-total");
		  	      row.appendChild(totalCell);

		  	      document.getElementById("tableBody").appendChild(row);
		  	  }

		  	  // Attach event listener to "Add Row" button
		  	  document.getElementById("addRow").addEventListener("click", addRow);

		  	  // Ensure static rows are added on page load
		  	  addStaticRows();

		  	  // Fetch charge codes & populate existing table
		  	  fetchChargeCodes();
			  
			  
       function calculateTotals() {
		      let grandTotal = 0;
		      const rows = document.querySelectorAll('#tableBody tr');
		      const footerCells = document.querySelectorAll('#tableFooter tr td');

		      const period = periods[currentPeriodIndex];
		      const [startDay, startMonth, startYear] = period.start.split('/');
		      const [endDay, endMonth, endYear] = period.end.split('/');
		      const totalDays = new Date(`${endYear}-${endMonth}-${endDay}`).getDate() - new Date(`${startYear}-${startMonth}-${startDay}`).getDate() + 1;

		      // Initialize an array to store the total for each day
		      const totals = new Array(totalDays).fill(0);

		      // Ignore the first 2 static rows (Work Location, Company Code)
		      rows.forEach((row, rowIndex) => {
		          if (rowIndex < 2) return; // Skip static rows

		          const inputs = row.querySelectorAll('input[type="text"]');
		          let rowSum = 0; // Sum of this row's values

		          inputs.forEach((input, index) => {
		              const value = parseFloat(input.value) || 0;
		              totals[index] += value;
		              rowSum += value;
		          });	

		          // Update the row's total column
		          const totalCell = row.querySelector('.row-total');
		          if (totalCell) {
		              totalCell.textContent = rowSum.toFixed(2);
		          }

		          grandTotal += rowSum;
		      });

		      // Update the footer cells with the calculated totals
		      totals.forEach((total, index) => {
		          footerCells[index + 1].textContent = total.toFixed(2);
		      });

		      // Update the total column in the footer
		      document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
		  }



		            

		          // When adding new rows, update totals on input
		          document.getElementById('addRow').addEventListener('click', addRow);

		          // Initially update the table
		          updateTable();


		          function updateDropdowns() {
		              const selects = document.querySelectorAll('select');
		              const selectedValues = [...selects].map(select => select.value).filter(val => val !== '');

		              selects.forEach(select => {
		                  [...select.options].forEach(option => {
		                      if (selectedValues.includes(option.value) && option.value !== select.value) {
		                          option.disabled = true;
		                      } else {
		                          option.disabled = false;
		                      }
		                  });
		              });
		          }

		          document.getElementById('prevPeriod').addEventListener('click', function() {
		              if (currentPeriodIndex > 0) {
		                  currentPeriodIndex--;
		                  updateDropdown();
		                  updateTable();
		              }
		          });

		          document.getElementById('nextPeriod').addEventListener('click', function() {
		              if (currentPeriodIndex < periods.length - 1) {
		                  currentPeriodIndex++;
		                  updateDropdown();
		                  updateTable();
		              }
		          });

		          document.getElementById('periodDropdown').addEventListener('change', function() {
		              currentPeriodIndex = parseInt(this.value);
		              updateTable();
		          });

		          document.getElementById('calendarPicker').addEventListener('change', function() {
		              const selectedDate = new Date(this.value);
		              for (let i = 0; i < periods.length; i++) {
		                  const [startDay, startMonth, startYear] = periods[i].start.split('/');
		                  const [endDay, endMonth, endYear] = periods[i].end.split('/');
		                  const periodStart = new Date(`${startYear}-${startMonth}-${startDay}`);
		                  const periodEnd = new Date(`${endYear}-${endMonth}-${endDay}`);

		                  if (selectedDate >= periodStart && selectedDate <= periodEnd) {
		                      currentPeriodIndex = i;
		                      updateDropdown();
		                      updateTable();
		                      break;
		                  }
		              }
		          });

		          document.getElementById('calendarPicker').value = today.toISOString().split('T')[0];
		          setCalendarLimits();
		          updateDropdown();
		          updateTable();
		          document.getElementById('addRow').addEventListener('click', addRow);
</script>
 </body>
 </html>